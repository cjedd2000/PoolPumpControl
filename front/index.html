<html>
    <head>
        <meta name="viewport" charset="utf-8" content="width=device-width, initial-scale=1">
        <style>
            body {
                width: 100vw;
                height: 100vh;;
                margin: 0;
                padding: 0;
                background-color: rgb(27, 27, 27);
                color: rgb(0, 163, 0);
            }

            .container {
                height: 100vh;
                width: 100vw;
            }

            #debugContainer {
                position: absolute;
                width: 100%;
                height: 30%;
                bottom: 0px;
                overflow: hidden;
                outline-style:solid;
                padding: 0;
            }

            .debugTextConsole {
                position: absolute;
                width: 100%;
                height: 80%;
                bottom: 0;
                overflow: scroll;
                padding-left: 5px;
                padding-right: 5px;
                font-family: 'Courier New', Courier, monospace;
            }

            .staticInterface {
                padding-top: 3px;
                padding-left: 5px;
                padding-right: 5px;
                padding-bottom: 5px;
                font-size: x-large;
            }

            .button {
                background-color: #4CAF50; /* Green */
                border: none;
                color: white;
                padding-top: 20px;
                padding-bottom: 20px;
                padding-left: 7px;
                padding-right: 7px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
                margin: 4px 2px;
                cursor: pointer;
                border-radius: 8px;
                margin-top: 30px;
            }
        </style>
    </head>
    <title>Pool Pump Control</title>
    <body>
        <div class="container">
            <div class="staticInterface">
                <h2>Pool Pump Controller</h2>
                <hr>
                <div id="pumpState"> Connecting to Server... </div>
                <div id="waterTemp"></div>
                <div id="ambientTemp"></div>

                <button id="togglePumpState" class="button"> Toggle Pump Power </button>
            </div>

            <div id="debugContainer" class="debugFrame">
                <div id="debugHeader">
                    <a style="font-size: larger; font-weight: bold; padding-left: 5px;">Debugger</a>
                        <input type="checkbox" id="AutoScroll" name="AutoScroll" value="AutoScroll" style="position: absolute; right: 10px;">
                        <label style="position: absolute; right: 35px; font-weight: bold;" for="AutoScroll"> Auto Scroll</label><br>
                    
                </div>
                <hr>
                <div id="debugTextFieldDiv" class="debugTextConsole"> <pre id="debugTextField"></pre> </div>
            </div>
        </div>

        <script>
            var debuggerWsAddr = `ws://${window.location.hostname}/api/v1/ws/remoteDebugger`;
            //var debuggerWsAddr = `ws://192.168.1.173/api/v1/ws/remoteDebugger`;
            var dataWsAddr = `ws://${window.location.hostname}/api/v1/ws/data`;
            //var dataWsAddr = `ws://192.168.1.173/api/v1/ws/data`;

            const WS_DATA_NONE = 0;
            const WS_DATA_PUMP_STATE = 1;
            const WS_DATA_WATER_TEMP = 2;
            const WS_DATA_AMB_TEMP = 3;

            var debuggerWs;
            var dataWs;

            var dataConnectionAttempts = 0;
            var dataSocketTimeout;

            var automaticScrollDebugger = true;

            function initDebuggerWebSocket() {
                console.log('Trying to open a Debugger WebSocket connection...');
                debuggerWs = new WebSocket(debuggerWsAddr);
                debuggerWs.onopen    = onDebuggerOpen;
                debuggerWs.onclose   = onDebuggerClose;
                debuggerWs.onmessage = onDebuggerMessage;
            }

            function initDataWebSocket() {
                console.log('Trying to open a Data WebSocket connection...');
                dataWs = new WebSocket(dataWsAddr);
                dataWs.onopen    = onDataOpen;
                dataWs.onclose   = onDataClose;
                dataWs.onmessage = onDataMessage;
                dataWs.binaryType = "arraybuffer";
            }

            function onDebuggerOpen(event) {
                console.log('Debugger connection opened');
            }

            function onDataOpen(event) {
                console.log('Data connection opened');
                dataConnectionAttempts = 0;
                setDataTimeout();
            }

            function setDataTimeout() {
                dataSocketTimeout = setTimeout(function () { dataWs.close(); console.log('closed'); }, 20000);
            }

            function onDebuggerClose(event) {
                console.log('Connection closed');
                setTimeout(initDebuggerWebSocket, 2000);
            }

            function onDataClose(event) {
                console.log('Data connection closed');
                document.getElementById('pumpState').innerHTML = 'Disconnected Attempting to Reconnect (' + ++dataConnectionAttempts +')...';
                document.getElementById('waterTemp').innerHTML = '';
                document.getElementById('ambientTemp').innerHTML = '';
                setTimeout(initDataWebSocket, 2000);
            }

            function onDebuggerMessage(event) {
                console.log("Debugger Received: ")
                console.log(event.data)
                
                document.getElementById('debugTextField').innerHTML += event.data +'<br>';
                var scrollBody = document.getElementById('debugTextFieldDiv');

                if(automaticScrollDebugger) {
                    scrollBody.scrollTop = scrollBody.scrollHeight - scrollBody.clientHeight;
                }
            }

            function onDataMessage(event) {
                var type;
                var dataInt;
                var dataFloat;

                clearTimeout(dataSocketTimeout);
                setDataTimeout();

                console.log("Data Received: ")
                console.log(event.data)

                if(event.data.byteLength == 8)
                {
                    type = new Uint32Array(event.data)[0];
                    dataInt = new Uint32Array(event.data)[1];
                    dataFloat = new Float32Array(event.data)[1];
                    console.log("    Type: " + type);
                    console.log("  ValueI: " + dataInt);
                    console.log("  ValueF: " + dataFloat);
                }
                else
                {
                    console.log("Incorrect message length");
                    return;
                }

                switch(type)
                {
                    case WS_DATA_PUMP_STATE:
                        var state = 'Pump State: '
                        if(dataInt == 1)
                        {
                            state += 'Running';
                        }
                        else if(dataInt == 0)
                        {
                            state += 'Off';
                        }
                        else
                        {
                            state += 'ERROR'
                        }

                        document.getElementById('pumpState').innerHTML = state;

                        break;

                    case WS_DATA_WATER_TEMP:
                        if(dataFloat > -190.0)
                        {
                            document.getElementById('waterTemp').innerHTML = 'Water Temperature: ' + dataFloat.toFixed(2) + ' C';
                        }
                        else
                        {
                            // Error in temperature Reading
                            document.getElementById('waterTemp').innerHTML = 'Water Temperature: Sensor Error';
                        }
                        break;

                    case WS_DATA_AMB_TEMP:
                        if(dataFloat > -190.0)
                        {
                            document.getElementById('ambientTemp').innerHTML = 'Ambient Temperature: ' + dataFloat.toFixed(2) + ' C';
                        }
                        else
                        {
                            // Error in temperature Reading
                            document.getElementById('ambientTemp').innerHTML = 'Ambient Temperature: Sensor Error';
                        }
                        break;

                    default:
                        console.log("  Invalid Data Type");
                        break;
                }
            }

            window.addEventListener('load', onLoad);
            function onLoad(event) {
                initButton();
                initAutoScrollCheckbox();
                setTimeout(initDebuggerWebSocket, 200);
                setTimeout(initDataWebSocket, 200);
            }

            function initButton() {
                document.getElementById('togglePumpState').addEventListener('click', toggle);
            }

            function initAutoScrollCheckbox() {
                document.getElementById('AutoScroll').addEventListener('click', autoScroll);
                document.getElementById('AutoScroll').checked = automaticScrollDebugger;
            }

            function autoScroll() {
                if(document.getElementById('AutoScroll').checked) {
                    automaticScrollDebugger = true;
                }
                else {
                    automaticScrollDebugger = false;
                }
            }

            function toggle(){
                dataWs.send('toggle');
                console.log("Toggle Button Pressed")
            }
        </script>
    </body>
</html>